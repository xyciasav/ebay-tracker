{# templates/scanner_tool.html #}
{% extends "base.html" %}
{% block title %}Scanner Tool — eBay Tracker{% endblock %}

{% block content %}
<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
    <h3 style="margin:0;">Scanner / Comps Tool</h3>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn secondary" href="{{ url_for('item_new') }}">+ New Item</a>
      <a class="btn secondary" href="{{ url_for('index') }}">Back to List</a>
    </div>
  </div>

  <div class="small" style="margin-top:8px;">
    Scan a barcode, open eBay sold comps, then click “Use This Barcode” to start a new item with it pre-filled.
  </div>

  <hr style="margin:14px 0; border:0; border-top:1px solid var(--border);" />

  {# -------- BARCODE + SCANNER -------- #}
  <div>
    <label>Barcode (UPC/EAN)</label>

    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:end;">
      <input
        type="text"
        id="barcode"
        placeholder="Scan or type barcode"
        style="min-width:220px;"
        inputmode="numeric"
        autocomplete="off"
      />

      <button type="button" class="btn secondary" id="btnScanBarcode">Scan Barcode</button>
      <button type="button" class="btn secondary" id="btnCloseBarcode" style="display:none;">Close</button>

      <button type="button" class="btn" id="btnUseBarcode" disabled>
        Use This Barcode → New Item
      </button>

      <span class="small" id="barcodeStatus" style="min-width:220px;"></span>
    </div>

    <div id="barcodeScannerWrap" style="display:none; margin-top:10px;">
      <div class="card" style="padding:10px; max-width:420px;">
        <div class="small" style="margin-bottom:8px;">Point camera at barcode</div>

    <video
      id="barcodeVideo"
      playsinline
      webkit-playsinline
      muted
      autoplay
      style="display:block; width:100%; height:220px; object-fit:cover; border-radius:10px; background:#111;"
    ></video>


        <div class="small" id="scannerDebug" style="margin-top:8px;"></div>
      </div>
    </div>

    <div class="small" style="margin-top:6px;">
      Tip: camera scanning needs HTTPS (secure context). If preview is weird, try Chrome for Android.
    </div>
  </div>

  <hr style="margin:18px 0; border:0; border-top:1px solid var(--border);" />

  {# -------- COMPS + CALCULATOR -------- #}
  <div class="card" style="margin-top:12px;">
    <h3 style="margin:0 0 10px 0;">Comps (Quick Check)</h3>
    <div class="small" style="margin-bottom:10px;">
      Use barcode or keywords, then open sold listings on eBay. Use the calculator to estimate max buy price.
    </div>

    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; align-items:end;">
      <div>
        <label>Search phrase (barcode or keywords)</label>
        <input
          id="compsQuery"
          type="text"
          placeholder="UPC/Barcode or keywords like: Klask board game"
        />
        <div class="small" style="margin-top:6px;">
          Tip: keywords often work better than UPC for used items.
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button type="button" class="btn" id="btnOpenSold">Open eBay Sold Comps</button>
        <button type="button" class="btn secondary" id="btnOpenActive">Open eBay Active Listings</button>
      </div>
    </div>

    <hr style="margin:14px 0; border:0; border-top:1px solid var(--border2);" />

    <h4 style="margin:0 0 10px 0;">Deal Estimator (Profit from your COG)</h4>

<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; align-items:end;">
  <div>
    <label>Avg sold price (you eyeball)</label>
    <input id="avgSoldPrice" type="number" step="0.01" placeholder="e.g. 34.99" />
  </div>

  <div>
    <label>Your cost (COG)</label>
    <input id="cogInput" type="number" step="0.01" placeholder="e.g. 4.99" />
  </div>

  <div>
    <label>Shipping (preset)</label>
    <select id="shipPreset">
      <option value="6.50">Small (~$6.50)</option>
      <option value="10.50" selected>Medium (~$10.50)</option>
      <option value="18.00">Large (~$18.00)</option>
      <option value="custom">Custom…</option>
    </select>
  </div>

  <div>
    <label>Shipping you pay</label>
    <input id="shipYouPay" type="number" step="0.01" placeholder="e.g. 8.50" />
  </div>

  <div>
    <label>eBay fee % (approx)</label>
    <input id="ebayFeePct" type="number" step="0.01" value="13.25" />
  </div>

  <div>
    <label>Ad fee % (if promoted)</label>
    <input id="adFeePct" type="number" step="0.01" value="0" />
  </div>

  <div>
    <button type="button" class="btn" id="btnCalcDeal">Calculate</button>
  </div>
</div>

<div class="small" style="margin-top:10px;">
  Uses: <code>profit = avg_sold - fees - shipping - cog</code>
</div>

<div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
  <div class="card" style="padding:10px 12px;">
    <div class="small">Estimated Profit</div>
    <div style="font-size:22px; font-weight:800;" id="profitOut">$—</div>
  </div>

  <div class="card" style="padding:10px 12px;">
    <div class="small">Profit Margin</div>
    <div style="font-size:22px; font-weight:800;" id="marginOut">—%</div>
  </div>

  <div class="card" style="padding:10px 12px;">
    <div class="small">Break-even Max COG</div>
    <div style="font-size:22px; font-weight:800;" id="maxCogOut">$—</div>
  </div>
</div>
</div>  {# closes comps card #}

{# ZXing - keep this here so item pages stay light #}
<script src="https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js"></script>

<script>
  function el(id){ return document.getElementById(id); }

  function toNum(v) {
    if (v === null || v === undefined) return 0;
    const s = String(v).trim().replace("$", "").replace(",", "");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }
  function money(n) {
    if (!Number.isFinite(n)) return "—";
    return "$" + n.toFixed(2);
  }

  function setStatus(msg, isErr=false) {
    const s = el("barcodeStatus");
    if (!s) return;
    s.textContent = msg || "";
    s.style.color = isErr ? "var(--danger, #b00020)" : "var(--muted, #6b7280)";
  }

  function debug(msg) {
    const d = el("scannerDebug");
    if (!d) return;
    d.textContent = msg || "";
  }

  function ebaySoldUrl(q) {
    const s = encodeURIComponent(q.trim());
    return `https://www.ebay.com/sch/i.html?_nkw=${s}&LH_Sold=1&LH_Complete=1`;
  }
  function ebayActiveUrl(q) {
    const s = encodeURIComponent(q.trim());
    return `https://www.ebay.com/sch/i.html?_nkw=${s}`;
  }

  // --- scanner state ---
  let zxingReader = null;

  function showScannerUI(show) {
    el("barcodeScannerWrap").style.display = show ? "block" : "none";
    el("btnCloseBarcode").style.display = show ? "inline-block" : "none";
  }

  async function stopScanner() {
    try {
    if (zxingReader && zxingReader.reset) {
      zxingReader.reset();
    }
    } catch(e) {}

    const video = el("barcodeVideo");
    if (video && video.srcObject) {
      try {
        const stream = video.srcObject;
        stream.getTracks().forEach(t => t.stop());
      } catch(e) {}
      video.srcObject = null;
    }

    showScannerUI(false);
    setStatus("");
    debug("");
  }

  function enableUseButton() {
    const code = (el("barcode").value || "").trim();
    el("btnUseBarcode").disabled = !code;
  }

  async function startScanner() {
    showScannerUI(true);
    el("barcodeScannerWrap").scrollIntoView({ behavior: "smooth", block: "nearest" });

    debug("");
    setStatus("");

    if (!window.isSecureContext) {
      setStatus("Camera requires HTTPS (secure context).", true);
      debug(`isSecureContext=${window.isSecureContext} url=${location.href}`);
      return;
    }
    if (!navigator.mediaDevices?.getUserMedia) {
      setStatus("Camera API not available in this browser.", true);
      debug("navigator.mediaDevices.getUserMedia missing");
      return;
    }
    if (!window.ZXingBrowser) {
      setStatus("Scanner library failed to load (ZXing).", true);
      debug("ZXingBrowser missing (blocked by CSP / network?)");
      return;
    }

    const videoEl = el("barcodeVideo");
    videoEl.muted = true;
    videoEl.setAttribute("muted", "");
    videoEl.setAttribute("playsinline", "");
    videoEl.setAttribute("webkit-playsinline", "");
    videoEl.setAttribute("autoplay", "");

    if (!zxingReader) zxingReader = new ZXingBrowser.BrowserMultiFormatReader();

    setStatus("Starting camera…");

    try {
      // Force rear camera via constraints (works better on Brave/Android)
      const constraints = {
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      };

      await zxingReader.decodeFromConstraints(
        constraints,
        videoEl,
        (result, err) => {
          if (result) {
            const code = result.getText ? result.getText() : String(result.text || result);
            el("barcode").value = code;

            if (!el("compsQuery").value.trim()) el("compsQuery").value = code;
            setStatus("Scanned: " + code);

            enableUseButton();
            stopScanner(); // hides preview + stops camera
          } else if (err) {
            const name = err.name || "";
            if (name && name !== "NotFoundException") debug(`scan err: ${name}`);
          }
        }
      );

      // Kick video rendering on mobile (Brave/Android often needs this)
      setTimeout(() => {
        videoEl.play?.().catch(() => {});
      }, 200);

      setStatus("Camera ready. Point at barcode…");
    } catch (err) {
      const msg = err?.name ? `${err.name}: ${err.message || ""}` : String(err);
      setStatus("Camera failed to start: " + msg, true);
      debug(msg);
      await stopScanner();
    }
  }

  // --- defaults for calculator ---
  const LS_KEY = "ebayTrackerCompsDefaults";

  function loadDefaults() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const d = JSON.parse(raw);
      if (d && typeof d === "object") {
        if (d.ebayFeePct != null) el("ebayFeePct").value = d.ebayFeePct;
        if (d.adFeePct != null) el("adFeePct").value = d.adFeePct;
        if (d.shipYouPay != null) el("shipYouPay").value = d.shipYouPay;
        if (d.cogInput != null) el("cogInput").value = d.cogInput;
      }
    } catch (e) {}
  }

  function saveDefaults() {
    const d = {
      ebayFeePct: toNum(el("ebayFeePct").value),
      adFeePct: toNum(el("adFeePct").value),
      shipYouPay: toNum(el("shipYouPay").value),
      cogInput: toNum(el("cogInput").value),
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(d)); } catch (e) {}
  }


  function syncCompsQueryDefault() {
    const cq = el("compsQuery");
    if (!cq.value.trim()) {
      const b = (el("barcode").value || "").trim();
      if (b) cq.value = b;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadDefaults();

    el("barcode").addEventListener("input", () => {
      syncCompsQueryDefault();
      enableUseButton();
    });

    el("btnUseBarcode").addEventListener("click", () => {
      const code = (el("barcode").value || "").trim();
      if (!code) return;
      window.location.href = `{{ url_for('item_new') }}?barcode=${encodeURIComponent(code)}`;
    });

    el("shipPreset")?.addEventListener("change", () => {
      const v = el("shipPreset").value;
      if (v !== "custom") el("shipYouPay").value = v;
    });

    el("btnOpenSold")?.addEventListener("click", () => {
      syncCompsQueryDefault();
      const q = el("compsQuery").value.trim();
      if (!q) { alert("Enter a barcode or keywords first."); return; }
      window.open(ebaySoldUrl(q), "_blank", "noopener,noreferrer");
    });

    el("btnOpenActive")?.addEventListener("click", () => {
      syncCompsQueryDefault();
      const q = el("compsQuery").value.trim();
      if (!q) { alert("Enter a barcode or keywords first."); return; }
      window.open(ebayActiveUrl(q), "_blank", "noopener,noreferrer");
    });

    el("btnCalcDeal")?.addEventListener("click", () => {
      const avgSold = toNum(el("avgSoldPrice").value);
      const cog = toNum(el("cogInput").value);
      const shipPay = toNum(el("shipYouPay").value);
      const ebayPct = toNum(el("ebayFeePct").value) / 100.0;
      const adPct = toNum(el("adFeePct").value) / 100.0;

      saveDefaults();

      if (avgSold <= 0) { alert("Enter an Avg sold price first."); return; }

      const feeTotal = avgSold * (ebayPct + adPct);
      const profit = avgSold - feeTotal - shipPay - cog;
      const margin = avgSold > 0 ? (profit / avgSold) * 100 : 0;
      const maxCog = avgSold - feeTotal - shipPay;

      el("profitOut").textContent = money(profit);
      el("marginOut").textContent = Number.isFinite(margin) ? margin.toFixed(1) + "%" : "—%";
      el("maxCogOut").textContent = money(maxCog);
    });

    el("btnScanBarcode")?.addEventListener("click", startScanner);
    el("btnCloseBarcode")?.addEventListener("click", stopScanner);

    enableUseButton();
  });
</script>

  </div>   {# closes comps card #}
</div>     {# closes outer page card #}

{% endblock %}

