{# templates/item_new.html #}
{% extends "base.html" %}
{% block title %}New Item — eBay Tracker{% endblock %}

{% block content %}
<div class="card">
  <h3 style="margin-top:0;">New Item</h3>
  <form method="post" enctype="multipart/form-data">
    <div class="row" style="display:flex; gap:12px; flex-wrap:wrap;">
      <div style="flex:1; min-width:220px;">
        <label>Item Name *</label>
        <input name="item_name" required>
      </div>
      <div style="flex:1; min-width:220px;">
        <label>Platform</label>
        <input list="platform_list" name="platform" placeholder="eBay">
        <datalist id="platform_list">
          {% for p in platforms %}
            <option value="{{ p }}"></option>
          {% endfor %}
        </datalist>
      </div>
    </div>

    <!-- ===================== BARCODE + SCANNER ===================== -->
    <div style="margin-top:10px;">
      <label>Barcode (UPC/EAN)</label>

      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:end;">
        <input
          type="text"
          name="barcode"
          id="barcode"
          value="{{ item.barcode if item else '' }}"
          placeholder="Scan or type barcode"
          style="min-width:220px;"
        />

        <button type="button" class="btn secondary" id="btnScanBarcode">
          Scan Barcode
        </button>

        <span class="small" id="barcodeStatus" style="min-width:220px;"></span>
      </div>

      <div class="small">
        Tip: scanning needs HTTPS (or localhost). If it can’t access the camera, you’ll see a message here.
      </div>

      <!-- Inline camera box (small, directly under Scan Barcode) -->
      <div id="barcodeScannerWrap" style="display:none; margin-top:10px;">
        <div class="card" style="padding:10px; max-width:360px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <strong>Scanner</strong>
            <button type="button" class="btn secondary" id="btnCloseBarcode">Close</button>
          </div>

          <video
            id="barcodeVideo"
            autoplay
            playsinline
            webkit-playsinline
            muted
            style="display:block; width:100%; height:200px; object-fit:cover; border-radius:10px; background:#111; margin-top:10px;"
          ></video>

          <div class="small" style="margin-top:8px;" id="scannerDebug"></div>
        </div>
      </div>

      <div class="small" style="margin-top:6px;">
        Tip: hold steady, fill the frame with the barcode.
      </div>
    </div>

    <hr style="margin:18px 0; border:0; border-top:1px solid var(--border);" />

    <!-- ===================== COMPS + CALCULATOR ===================== -->
    <div class="card" style="margin-top:12px;">
      <h3 style="margin:0 0 10px 0;">Comps (Quick Check)</h3>
      <div class="small" style="margin-bottom:10px;">
        Scan a barcode (or type keywords), then open sold listings on eBay. Use the calculator to estimate your max buy price.
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; align-items:end;">
        <div>
          <label>Search phrase (barcode or keywords)</label>
          <input
            id="compsQuery"
            type="text"
            placeholder="UPC/Barcode or keywords like: Klask board game"
          />
          <div class="small" style="margin-top:6px;">
            Tip: keywords often work better than UPC for used items.
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button" class="btn" id="btnOpenSold">
            Open eBay Sold Comps
          </button>
          <button type="button" class="btn secondary" id="btnOpenActive">
            Open eBay Active Listings
          </button>
        </div>
      </div>

      <hr style="margin:14px 0; border:0; border-top:1px solid var(--border2);" />

      <h4 style="margin:0 0 10px 0;">Worth it? (Max Buy Price)</h4>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; align-items:end;">
        <div>
          <label>Avg sold price (you eyeball)</label>
          <input id="avgSoldPrice" type="number" step="0.01" placeholder="e.g. 34.99" />
        </div>

        <div>
          <label>Shipping (preset)</label>
          <select id="shipPreset">
            <option value="6.50">Small (~$6.50)</option>
            <option value="10.50" selected>Medium (~$10.50)</option>
            <option value="18.00">Large (~$18.00)</option>
            <option value="custom">Custom…</option>
          </select>
        </div>

        <div>
          <label>Shipping you pay</label>
          <input id="shipYouPay" type="number" step="0.01" placeholder="e.g. 8.50" />
        </div>

        <div>
          <label>eBay fee % (approx)</label>
          <input id="ebayFeePct" type="number" step="0.01" value="13.25" />
        </div>

        <div>
          <label>Ad fee % (if promoted)</label>
          <input id="adFeePct" type="number" step="0.01" value="0" />
        </div>

        <div>
          <label>Desired profit</label>
          <input id="desiredProfit" type="number" step="0.01" value="15" />
        </div>

        <div>
          <button type="button" class="btn" id="btnCalcMaxBuy">Calculate</button>
        </div>
      </div>

      <div class="small" style="margin-top:10px;">
        Uses: <code>max_buy = avg_sold - shipping_you_pay - (avg_sold * (ebay_fee% + ad_fee%)) - desired_profit</code>
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <div class="card" style="padding:10px 12px;">
          <div class="small">Max Buy Price</div>
          <div style="font-size:22px; font-weight:800;" id="maxBuyOut">$—</div>
        </div>

        <div class="card" style="padding:10px 12px;">
          <div class="small">Estimated Profit (if you pay Max)</div>
          <div style="font-size:22px; font-weight:800;" id="profitOut">$—</div>
        </div>
      </div>
    </div>

    <!-- ===================== MAIN FORM FIELDS ===================== -->
    <div class="row" style="display:flex; gap:12px; flex-wrap:wrap; margin-top:10px;">
      <div style="flex:1; min-width:220px;">
        <label>Category</label>
        <input list="category_list" name="category">
        <datalist id="category_list">
          {% for c in categories %}
            <option value="{{ c }}"></option>
          {% endfor %}
        </datalist>
      </div>
      <div style="flex:1; min-width:220px;">
        <label>Sub-Category</label>
        <input list="sub_category_list" name="sub_category">
        <datalist id="sub_category_list">
          {% for sc in sub_categories %}
            <option value="{{ sc }}"></option>
          {% endfor %}
        </datalist>
      </div>
    </div>

    <div class="row" style="display:flex; gap:12px; flex-wrap:wrap; margin-top:10px;">
      <div style="flex:1; min-width:220px;">
        <label>COG</label>
        <input name="cog" placeholder="12.50">
      </div>
      <div style="flex:1; min-width:220px;">
        <label>Sale Price</label>
        <input name="sale_price" placeholder="45.00">
      </div>
      <div style="flex:1; min-width:220px;">
        <label>Buyer Paid Amount</label>
        <input name="buyer_paid_amount" placeholder="45.00">
      </div>
    </div>

    <div class="row" style="display:flex; gap:12px; flex-wrap:wrap; margin-top:10px;">
      <div style="flex:1; min-width:220px;">
        <label>Ad Fee</label>
        <input name="ad_fee" placeholder="0.00">
      </div>
      <div style="flex:1; min-width:220px;">
        <label>eBay Fee</label>
        <input name="ebay_fee" placeholder="0.00">
      </div>
      <div style="flex:1; min-width:220px;">
        <label>Shipping</label>
        <input name="shipping" placeholder="0.00">
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Source Location</label>
      <input
        type="text"
        name="source_location"
        list="source_locations_list"
        placeholder="Goodwill, Ross, Estate sale, Target clearance..."
      />
      <datalist id="source_locations_list">
        {% for s in source_locations %}
          <option value="{{ s }}"></option>
        {% endfor %}
      </datalist>
    </div>

    <div class="row" style="display:flex; gap:12px; flex-wrap:wrap; margin-top:10px;">
      <div style="flex:1; min-width:220px;">
        <label>Date Listed</label>
        <input type="date" name="date_listed">
      </div>
      <div style="flex:1; min-width:220px;">
        <label>Date Sold</label>
        <input type="date" name="date_sold">
      </div>
      <div style="flex:1; min-width:220px;">
        <label>Sold (Y/N)</label>
        <select name="sold">
          <option value="N" selected>N</option>
          <option value="Y">Y</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Notes</label>
      <textarea name="notes"></textarea>
    </div>

    <div style="margin-top:10px;">
      <label>Add Photos</label>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
        <button type="button" class="btn secondary" onclick="document.getElementById('cameraInput').click()">
          Take Photo
        </button>

        <button type="button" class="btn secondary" onclick="document.getElementById('galleryInput').click()">
          Choose From Library
        </button>
      </div>

      <!-- Camera-only input -->
      <input
        id="cameraInput"
        type="file"
        name="photos"
        accept="image/*"
        capture="environment"
        style="display:none;"
      >

      <!-- Gallery/files input -->
      <input
        id="galleryInput"
        type="file"
        name="photos"
        accept="image/*"
        multiple
        style="display:none;"
      >

      <div class="small" style="margin-top:8px;">
        Use “Take Photo” for the camera, or “Choose From Library” to pick existing pics.
      </div>
    </div>

    <div style="margin-top:14px; display:flex; gap:10px;">
      <button class="btn" type="submit">Create</button>
      <a class="btn secondary" href="{{ url_for('index') }}">Cancel</a>
    </div>
  </form>
</div>

<!-- ===================== JAVASCRIPT (ALL) ===================== -->
<script>
  // Single $ helper (avoid duplicates)
  function $(id){ return document.getElementById(id); }

  // --------------------- Shipping preset -> shipping input ---------------------
  $("shipPreset")?.addEventListener("change", () => {
    const v = $("shipPreset").value;
    if (v === "custom") return;
    $("shipYouPay").value = v;
  });

  // --------------------- Comps + Calculator helpers ---------------------
  function toNum(v) {
    if (v === null || v === undefined) return 0;
    const s = String(v).trim().replace("$", "").replace(",", "");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  }
  function money(n) {
    if (!Number.isFinite(n)) return "—";
    return "$" + n.toFixed(2);
  }
  function ebaySoldUrl(q) {
    const s = encodeURIComponent(q.trim());
    return `https://www.ebay.com/sch/i.html?_nkw=${s}&LH_Sold=1&LH_Complete=1`;
  }
  function ebayActiveUrl(q) {
    const s = encodeURIComponent(q.trim());
    return `https://www.ebay.com/sch/i.html?_nkw=${s}`;
  }

  function getBarcodeValue() {
    const el =
      document.querySelector('input[name="barcode"]') ||
      document.getElementById("barcode");
    return el ? el.value : "";
  }
  function syncQueryDefault() {
    const existing = $("compsQuery").value.trim();
    if (existing) return;
    const b = (getBarcodeValue() || "").trim();
    if (b) $("compsQuery").value = b;
  }

  // Remember calculator defaults
  const LS_KEY = "ebayTrackerCompsDefaults";
  function loadDefaults() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const d = JSON.parse(raw);
      if (d && typeof d === "object") {
        if (d.ebayFeePct != null) $("ebayFeePct").value = d.ebayFeePct;
        if (d.adFeePct != null) $("adFeePct").value = d.adFeePct;
        if (d.desiredProfit != null) $("desiredProfit").value = d.desiredProfit;
        if (d.shipYouPay != null) $("shipYouPay").value = d.shipYouPay;
      }
    } catch (e) {}
  }
  function saveDefaults() {
    const d = {
      ebayFeePct: toNum($("ebayFeePct").value),
      adFeePct: toNum($("adFeePct").value),
      desiredProfit: toNum($("desiredProfit").value),
      shipYouPay: toNum($("shipYouPay").value),
    };
    try { localStorage.setItem(LS_KEY, JSON.stringify(d)); } catch (e) {}
  }

  // --------------------- Inline Scanner (FIXED AbortError) ---------------------
  let barcodeStream = null;

  function setStatus(msg, isErr=false) {
    const s = $("barcodeStatus");
    if (!s) return;
    s.textContent = msg;
    s.style.color = isErr ? "var(--danger, #b00020)" : "var(--muted, #6b7280)";
  }

  async function stopInlineScanner() {
    const video = $("barcodeVideo");
    if (video) {
      try { video.pause(); } catch(e) {}
      video.srcObject = null;
      // Force iOS to drop the pipeline fully
      video.removeAttribute("src");
      video.load();
    }
    if (barcodeStream) {
      barcodeStream.getTracks().forEach(t => t.stop());
      barcodeStream = null;
    }
  }

  async function startInlineScanner() {
    // If user taps multiple times, stop previous run first
    await stopInlineScanner();

    $("barcodeScannerWrap").style.display = "block";
    // keep it directly under the button; no scrollIntoView (this can interrupt play on mobile)
    // $("barcodeScannerWrap").scrollIntoView({ behavior: "smooth", block: "start" });

    if (!window.isSecureContext) {
      setStatus("Camera requires HTTPS (secure context). Current page is NOT secure.", true);
      $("scannerDebug").textContent = `isSecureContext=${window.isSecureContext}`;
      return;
    }
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      setStatus("Browser has no camera API (navigator.mediaDevices.getUserMedia missing).", true);
      $("scannerDebug").textContent = `navigator.mediaDevices=${!!navigator.mediaDevices}`;
      return;
    }

    try {
      setStatus("Requesting camera permission…");

      const constraints = {
        audio: false,
        video: { facingMode: { ideal: "environment" } }
      };

      barcodeStream = await navigator.mediaDevices.getUserMedia(constraints);

      const video = $("barcodeVideo");
      video.srcObject = barcodeStream;

      // Key fix for your error:
      // Don't call play() immediately while the element is still "loading" a new stream.
      // Wait for metadata, then play.
      const playPromise = new Promise((resolve, reject) => {
        const onLoaded = async () => {
          cleanup();
          try {
            const p = video.play();
            if (p && typeof p.then === "function") await p;
            resolve();
          } catch (e) {
            reject(e);
          }
        };
        const onError = (e) => { cleanup(); reject(e); };
        const cleanup = () => {
          video.removeEventListener("loadedmetadata", onLoaded);
          video.removeEventListener("error", onError);
        };
        video.addEventListener("loadedmetadata", onLoaded, { once: true });
        video.addEventListener("error", onError, { once: true });
      });

      await playPromise;

      setStatus("Camera started. Point at barcode…");

      setTimeout(() => {
        $("scannerDebug").textContent =
          `videoWidth=${video.videoWidth}, videoHeight=${video.videoHeight}, readyState=${video.readyState}`;
        if (!video.videoWidth) {
          setStatus("Camera is on but preview not rendering (iOS inline/autoplay quirk).", true);
        }
      }, 600);

      // (Decoding step comes next—once preview is stable)
    } catch (err) {
      console.error("Camera error:", err);
      const msg = (err && err.name) ? `${err.name}: ${err.message || ""}` : String(err);
      setStatus("Camera failed: " + msg, true);
      $("scannerDebug").textContent = msg;
      await stopInlineScanner();
    }
  }

  // --------------------- Wire everything on DOMContentLoaded ---------------------
  document.addEventListener("DOMContentLoaded", () => {
    loadDefaults();
    syncQueryDefault();

    $("btnOpenSold")?.addEventListener("click", () => {
      syncQueryDefault();
      const q = $("compsQuery").value.trim();
      if (!q) { alert("Enter a barcode or keywords first."); return; }
      window.open(ebaySoldUrl(q), "_blank", "noopener,noreferrer");
    });

    $("btnOpenActive")?.addEventListener("click", () => {
      syncQueryDefault();
      const q = $("compsQuery").value.trim();
      if (!q) { alert("Enter a barcode or keywords first."); return; }
      window.open(ebayActiveUrl(q), "_blank", "noopener,noreferrer");
    });

    $("btnCalcMaxBuy")?.addEventListener("click", () => {
      const avgSold = toNum($("avgSoldPrice").value);
      const shipPay = toNum($("shipYouPay").value);
      const ebayPct = toNum($("ebayFeePct").value) / 100.0;
      const adPct = toNum($("adFeePct").value) / 100.0;
      const desired = toNum($("desiredProfit").value);

      saveDefaults();

      if (avgSold <= 0) { alert("Enter an Avg sold price first."); return; }

      const feeTotal = avgSold * (ebayPct + adPct);
      const maxBuy = avgSold - shipPay - feeTotal - desired;
      const estProfit = avgSold - (maxBuy + shipPay + feeTotal);

      $("maxBuyOut").textContent = money(maxBuy);
      $("profitOut").textContent = money(estProfit);
    });

    // Barcode input -> auto-fill comps query if empty
    const barcodeEl = $("barcode");
    if (barcodeEl) {
      barcodeEl.addEventListener("input", () => {
        const q = $("compsQuery").value.trim();
        if (!q) syncQueryDefault();
      });
    }

    // Scanner buttons
    $("btnScanBarcode")?.addEventListener("click", () => startInlineScanner());

    $("btnCloseBarcode")?.addEventListener("click", async () => {
      await stopInlineScanner();
      $("barcodeScannerWrap").style.display = "none";
      setStatus("Scanner closed.");
    });
  });
</script>

{% endblock %}
